# mise configuration for duke-sheets
# See https://mise.jdx.dev for documentation

[tools]
uv = "0.9"
rust = "1.92"
node = "20"
"cargo:wasm-pack" = "latest"

# =============================================================================
# Setup Tasks
# =============================================================================

[tasks.setup]
description = "Install all binding dependencies (run once)"
run = """
#!/bin/bash
set -e

echo "=== Setting up duke-sheets bindings ==="

echo ""
echo "1. Adding WASM target to Rust toolchain..."
rustup target add wasm32-unknown-unknown

echo ""
echo "2. Installing maturin via uv tool..."
uv tool install maturin

echo ""
echo "3. Setting up Python bindings environment..."
cd bindings/python
uv sync

echo ""
echo "=== Setup complete! ==="
echo ""
echo "Available commands:"
echo "  mise run build          # Build all bindings"
echo "  mise run test           # Build and test all bindings"
echo "  mise run build:python   # Build Python bindings only"
echo "  mise run build:wasm     # Build WASM bindings only"
"""

# =============================================================================
# Build Tasks
# =============================================================================

[tasks.build]
description = "Build all bindings"
depends = ["build:python", "build:wasm"]

[tasks."build:python"]
description = "Build Python bindings"
dir = "bindings/python"
run = "uv run maturin develop"

[tasks."build:wasm"]
description = "Build WASM bindings"
dir = "bindings/wasm"
run = "wasm-pack build --target web --dev"

[tasks."build:wasm:release"]
description = "Build WASM bindings (release)"
dir = "bindings/wasm"
run = "wasm-pack build --target web --release"

# =============================================================================
# Test Tasks
# =============================================================================

[tasks.test]
description = "Build and test all bindings"
depends = ["test:python", "test:wasm"]

[tasks."test:python"]
description = "Test Python bindings"
dir = "bindings/python"
depends = ["build:python"]
run = "uv run pytest tests/ -v"

[tasks."test:wasm"]
description = "Test WASM bindings (requires Firefox)"
dir = "bindings/wasm"
run = "wasm-pack test --headless --firefox"

[tasks."test:wasm:node"]
description = "Test WASM bindings (Node.js)"
dir = "bindings/wasm"
run = "wasm-pack test --node"

[tasks."test:bindings"]
alias = "tb"
description = "Alias for 'mise run test'"
depends = ["test"]

# =============================================================================
# Clean Tasks
# =============================================================================

[tasks.clean]
description = "Clean all binding build artifacts"
depends = ["clean:python", "clean:wasm"]

[tasks."clean:python"]
description = "Clean Python binding artifacts"
dir = "bindings/python"
run = """
rm -rf target/
rm -rf .venv/
rm -rf *.egg-info/
rm -rf dist/
rm -rf build/
find . -name "*.so" -delete
find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
"""

[tasks."clean:wasm"]
description = "Clean WASM binding artifacts"
dir = "bindings/wasm"
run = """
rm -rf target/
rm -rf pkg/
"""

# =============================================================================
# Development Tasks
# =============================================================================

[tasks.demo]
description = "Build WASM bindings and serve the demo at http://localhost:8080"
depends = ["build:wasm"]
dir = "bindings/wasm"
run = "python3 -m http.server 8080"

[tasks.dev]
description = "Build bindings in development mode and run tests"
depends = ["build", "test"]

[tasks."dev:python"]
description = "Python development cycle"
depends = ["build:python", "test:python"]

[tasks."dev:wasm"]
description = "WASM development cycle"
depends = ["build:wasm", "test:wasm:node"]

# =============================================================================
# Docker Image Tasks
# =============================================================================

[tasks."docker:build"]
description = "Build the PyUNO Docker image (LibreOffice + URP)"
run = "docker build -t duke-sheets-pyuno tests/fixtures/pyuno"

# =============================================================================
# E2E Test Tasks
# =============================================================================

[tasks."test:e2e"]
description = "Run E2E tests for XLSX reader (requires LibreOffice via urp:start)"
run = "cargo test -p duke-sheets-xlsx --test e2e -- --test-threads=1 --nocapture"

# =============================================================================
# URP Bridge Tasks (LibreOffice direct connection via UNO Remote Protocol)
# =============================================================================

[tasks."urp:start"]
description = "Start LibreOffice in Docker with URP socket on port 2002 and shared /tmp volume"
depends = ["docker:build"]
run = """
#!/bin/bash
set -e
mkdir -p /tmp/duke-sheets-urp
echo "Starting LibreOffice with URP socket on localhost:2002..."
echo "Shared volume: /tmp/duke-sheets-urp"
echo "Press Ctrl+C to stop."
docker run --rm -p 2002:2002 -v /tmp/duke-sheets-urp:/tmp/duke-sheets-urp duke-sheets-pyuno \
  bash -c 'soffice --headless --accept="socket,host=0.0.0.0,port=2002;urp;StarOffice.ComponentContext" & sleep 2 && echo "LibreOffice ready on port 2002" && wait'
"""

[tasks."test:urp"]
description = "Run URP integration tests (starts LibreOffice in Docker automatically)"
depends = ["docker:build"]
run = """
#!/bin/bash
set -e

mkdir -p /tmp/duke-sheets-urp

# Start LibreOffice in Docker in the background
echo "Starting LibreOffice in Docker..."
CONTAINER_ID=$(docker run -d --rm -p 2002:2002 -v /tmp/duke-sheets-urp:/tmp/duke-sheets-urp duke-sheets-pyuno \
  bash -c 'soffice --headless --accept="socket,host=0.0.0.0,port=2002;urp;StarOffice.ComponentContext" & sleep 999999')

# Wait for port to be ready
echo "Waiting for LibreOffice to be ready..."
for i in $(seq 1 30); do
  if nc -z localhost 2002 2>/dev/null; then
    echo "LibreOffice ready (took ${i}s)"
    break
  fi
  if [ "$i" -eq 30 ]; then
    echo "ERROR: Timeout waiting for LibreOffice"
    docker stop "$CONTAINER_ID" 2>/dev/null || true
    exit 1
  fi
  sleep 1
done

# Run the integration tests
echo "Running URP integration tests..."
cargo test -p duke-sheets-libreoffice --test integration -- --nocapture
TEST_EXIT=$?

# Stop the container
echo "Stopping LibreOffice..."
docker stop "$CONTAINER_ID" 2>/dev/null || true

exit $TEST_EXIT
"""
