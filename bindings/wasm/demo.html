<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duke Sheets - WASM Spreadsheet Demo</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            margin: 0 0 20px 0;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .spreadsheet {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0;
            min-width: 80px;
            height: 28px;
        }
        th {
            background: #f0f0f0;
            font-weight: 500;
            font-size: 12px;
            color: #666;
        }
        .row-header {
            width: 40px;
            min-width: 40px;
            text-align: center;
        }
        td input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 4px 8px;
            font-size: 13px;
            outline: none;
        }
        td input:focus {
            background: #e8f4fc;
        }
        td.formula input {
            color: #0066cc;
        }
        .toolbar {
            padding: 10px;
            background: #f8f8f8;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .toolbar button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .toolbar button:hover {
            background: #45a049;
        }
        .toolbar button.open-btn {
            background: #2196F3;
        }
        .toolbar button.open-btn:hover {
            background: #1976D2;
        }
        .toolbar .file-name {
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        .formula-bar {
            padding: 8px 10px;
            background: white;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .formula-bar .cell-ref {
            font-weight: bold;
            width: 50px;
            text-align: center;
            color: #666;
        }
        .formula-bar input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .sheet-tabs {
            display: flex;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
            overflow-x: auto;
            min-height: 32px;
        }
        .sheet-tab {
            padding: 6px 16px;
            font-size: 12px;
            cursor: pointer;
            border: none;
            background: transparent;
            border-right: 1px solid #ddd;
            white-space: nowrap;
            color: #555;
        }
        .sheet-tab:hover {
            background: #e8e8e8;
        }
        .sheet-tab.active {
            background: white;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #2196F3;
        }
        .status {
            padding: 8px 10px;
            background: #f8f8f8;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }
        .examples {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .examples h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .examples ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
        }
        .examples li {
            margin: 5px 0;
        }
        .examples code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .drop-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(33, 150, 243, 0.15);
            border: 4px dashed #2196F3;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #2196F3;
            pointer-events: none;
        }
        .drop-overlay.visible {
            display: flex;
        }
    </style>
</head>
<body>
    <div id="drop-overlay" class="drop-overlay">Drop .xlsx file to open</div>
    <div class="container">
        <h1>Duke Sheets - WASM Spreadsheet Demo</h1>

        <div class="spreadsheet">
            <div class="toolbar">
                <button class="open-btn" onclick="openFile()">Open .xlsx</button>
                <input type="file" id="file-input" accept=".xlsx,.xlsm" style="display:none">
                <button onclick="calculate()">Calculate (F9)</button>
                <span id="calc-status"></span>
                <span id="file-name" class="file-name"></span>
            </div>
            <div class="formula-bar">
                <span class="cell-ref" id="current-cell">A1</span>
                <input type="text" id="formula-input" placeholder="Enter value or formula (e.g., =A1+B1)">
            </div>
            <div style="overflow-x: auto;">
                <table id="grid"></table>
            </div>
            <div class="sheet-tabs" id="sheet-tabs"></div>
            <div class="status" id="status">Ready</div>
        </div>

        <div class="examples">
            <h3>Try these formulas:</h3>
            <ul>
                <li>Basic math: <code>=A1+B1</code>, <code>=A1*2</code>, <code>=10/2</code></li>
                <li>Functions: <code>=SUM(A1:A5)</code>, <code>=AVERAGE(A1:B3)</code></li>
                <li>Conditionals: <code>=IF(A1>10,"Big","Small")</code></li>
                <li>Text: <code>=CONCAT(A1," ",B1)</code>, <code>=LEN(A1)</code></li>
                <li>Or <strong>open an .xlsx file</strong> to view its contents</li>
            </ul>
        </div>
    </div>

    <!--
        NOTE: This page must be served over HTTP(S), not opened as a file:// URL.
        ES modules require CORS headers that the file:// protocol cannot provide.
        Use: python3 -m http.server 8080   (then open http://localhost:8080/demo.html)
    -->
    <script type="module">
        import init, { Workbook } from './pkg/duke_sheets_wasm.js';

        const MIN_ROWS = 15;
        const MIN_COLS = 8;
        const MAX_ROWS = 200;
        const MAX_COLS = 26;

        let workbook;
        let sheet;
        let activeSheetIndex = 0;
        let selectedCell = { row: 0, col: 0 };
        let rows = MIN_ROWS;
        let cols = MIN_COLS;

        // Column letter helper (supports A-Z)
        function colLetter(col) {
            if (col < 26) return String.fromCharCode(65 + col);
            return String.fromCharCode(64 + Math.floor(col / 26)) +
                   String.fromCharCode(65 + (col % 26));
        }

        function cellAddress(row, col) {
            return colLetter(col) + (row + 1);
        }

        // =====================================================================
        // Initialization
        // =====================================================================

        async function main() {
            await init();

            workbook = new Workbook();
            activeSheetIndex = 0;
            sheet = workbook.getSheet(0);

            createGrid();
            renderSheetTabs();
            selectCell(0, 0);

            // Formula bar input handler
            const formulaInput = document.getElementById('formula-input');
            formulaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    setCellValue(selectedCell.row, selectedCell.col, formulaInput.value);
                    e.preventDefault();
                }
            });

            // Keyboard shortcut for calculate
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F9') {
                    calculate();
                    e.preventDefault();
                }
            });

            // File input handler
            document.getElementById('file-input').addEventListener('change', handleFileSelect);

            // Drag and drop
            setupDragDrop();

            document.getElementById('status').textContent = 'Spreadsheet ready - powered by Rust + WebAssembly';
        }

        // =====================================================================
        // File loading
        // =====================================================================

        window.openFile = function() {
            document.getElementById('file-input').click();
        };

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) loadFile(file);
            // Reset so the same file can be re-selected
            e.target.value = '';
        }

        async function loadFile(file) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `Loading ${file.name}...`;

            try {
                const buffer = await file.arrayBuffer();
                const bytes = new Uint8Array(buffer);

                const start = performance.now();
                workbook = Workbook.fromXlsxBytes(bytes);
                const elapsed = (performance.now() - start).toFixed(2);

                activeSheetIndex = 0;
                sheet = workbook.getSheet(0);

                // Determine grid size from used range
                resizeGridToData();
                createGrid();
                renderSheetTabs();
                updateGrid();
                selectCell(0, 0);

                // Auto-calculate formulas
                calculate();

                const sheetCount = workbook.sheetCount;
                document.getElementById('file-name').textContent = file.name;
                statusEl.textContent =
                    `Loaded "${file.name}" in ${elapsed}ms - ${sheetCount} sheet${sheetCount !== 1 ? 's' : ''}`;
            } catch (e) {
                console.error('Error loading file:', e);
                statusEl.textContent = 'Error loading file: ' + (e.message || e);
            }
        }

        function setupDragDrop() {
            const overlay = document.getElementById('drop-overlay');
            let dragCounter = 0;

            document.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                overlay.classList.add('visible');
            });
            document.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter <= 0) {
                    dragCounter = 0;
                    overlay.classList.remove('visible');
                }
            });
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                overlay.classList.remove('visible');
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xlsm'))) {
                    loadFile(file);
                } else if (file) {
                    document.getElementById('status').textContent =
                        'Unsupported file type. Please drop an .xlsx or .xlsm file.';
                }
            });
        }

        // =====================================================================
        // Grid sizing
        // =====================================================================

        function resizeGridToData() {
            const usedRange = sheet.usedRange();
            if (usedRange) {
                // usedRange returns [startRow, startCol, endRow, endCol] (0-based)
                rows = Math.max(MIN_ROWS, Math.min(MAX_ROWS, usedRange[2] + 2));
                cols = Math.max(MIN_COLS, Math.min(MAX_COLS, usedRange[3] + 2));
            } else {
                rows = MIN_ROWS;
                cols = MIN_COLS;
            }
        }

        // =====================================================================
        // Sheet tabs
        // =====================================================================

        function renderSheetTabs() {
            const container = document.getElementById('sheet-tabs');
            const names = workbook.sheetNames;
            container.innerHTML = names.map((name, i) =>
                `<button class="sheet-tab${i === activeSheetIndex ? ' active' : ''}"
                         onclick="switchSheet(${i})">${name}</button>`
            ).join('');
        }

        window.switchSheet = function(index) {
            activeSheetIndex = index;
            sheet = workbook.getSheet(index);
            resizeGridToData();
            createGrid();
            renderSheetTabs();
            updateGrid();
            selectCell(0, 0);
        };

        // =====================================================================
        // Grid rendering
        // =====================================================================

        function createGrid() {
            const table = document.getElementById('grid');
            let html = '<thead><tr><th class="row-header"></th>';

            for (let c = 0; c < cols; c++) {
                html += `<th>${colLetter(c)}</th>`;
            }
            html += '</tr></thead><tbody>';

            for (let r = 0; r < rows; r++) {
                html += `<tr><th class="row-header">${r + 1}</th>`;
                for (let c = 0; c < cols; c++) {
                    const addr = cellAddress(r, c);
                    html += `<td id="cell-${addr}"><input type="text"
                        data-row="${r}" data-col="${c}"
                        onfocus="selectCell(${r}, ${c})"
                        onchange="onCellChange(this)"
                        onkeydown="onCellKeydown(event, ${r}, ${c})"></td>`;
                }
                html += '</tr>';
            }
            html += '</tbody>';
            table.innerHTML = html;
        }

        // =====================================================================
        // Cell interaction
        // =====================================================================

        window.selectCell = function(row, col) {
            selectedCell = { row, col };
            const addr = cellAddress(row, col);
            document.getElementById('current-cell').textContent = addr;

            try {
                const cellVal = sheet.getCell(addr);
                const formulaInput = document.getElementById('formula-input');
                if (cellVal.isFormula) {
                    formulaInput.value = cellVal.formulaText() || '';
                } else {
                    formulaInput.value = cellVal.toString();
                }
            } catch (e) {
                console.error(e);
            }
        };

        window.onCellChange = function(input) {
            const row = parseInt(input.dataset.row);
            const col = parseInt(input.dataset.col);
            setCellValue(row, col, input.value);
        };

        window.onCellKeydown = function(event, row, col) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (row < rows - 1) {
                    const nextInput = document.querySelector(`input[data-row="${row+1}"][data-col="${col}"]`);
                    if (nextInput) nextInput.focus();
                }
            } else if (event.key === 'Tab') {
                event.preventDefault();
                const nextCol = event.shiftKey ? col - 1 : col + 1;
                if (nextCol >= 0 && nextCol < cols) {
                    const nextInput = document.querySelector(`input[data-row="${row}"][data-col="${nextCol}"]`);
                    if (nextInput) nextInput.focus();
                }
            } else if (event.key === 'ArrowDown' && !event.altKey) {
                if (row < rows - 1) {
                    const nextInput = document.querySelector(`input[data-row="${row+1}"][data-col="${col}"]`);
                    if (nextInput) nextInput.focus();
                }
            } else if (event.key === 'ArrowUp' && !event.altKey) {
                if (row > 0) {
                    const nextInput = document.querySelector(`input[data-row="${row-1}"][data-col="${col}"]`);
                    if (nextInput) nextInput.focus();
                }
            }
        };

        function setCellValue(row, col, value) {
            const addr = cellAddress(row, col);
            try {
                if (value.startsWith('=')) {
                    sheet.setFormula(addr, value);
                } else if (value === '') {
                    sheet.setCell(addr, null);
                } else {
                    const num = parseFloat(value);
                    if (!isNaN(num) && value.trim() === num.toString()) {
                        sheet.setCell(addr, num);
                    } else {
                        sheet.setCell(addr, value);
                    }
                }
                updateGrid();
            } catch (e) {
                console.error('Error setting cell:', e);
                document.getElementById('status').textContent = 'Error: ' + e.message;
            }
        }

        // =====================================================================
        // Calculation
        // =====================================================================

        window.calculate = function() {
            try {
                const start = performance.now();
                const stats = workbook.calculate();
                const elapsed = (performance.now() - start).toFixed(2);

                updateGrid();

                const statusText = `Calculated ${stats.cellsCalculated} cells in ${elapsed}ms`;
                document.getElementById('calc-status').textContent = statusText;
                document.getElementById('status').textContent = statusText +
                    (stats.errors > 0 ? ` (${stats.errors} errors)` : '');
            } catch (e) {
                console.error('Calculation error:', e);
                document.getElementById('status').textContent = 'Calculation error: ' + e.message;
            }
        };

        // =====================================================================
        // Grid update
        // =====================================================================

        function updateGrid() {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const addr = cellAddress(r, c);
                    const input = document.querySelector(`input[data-row="${r}"][data-col="${c}"]`);
                    if (!input) continue;
                    const td = input.parentElement;

                    try {
                        const cellVal = sheet.getCalculatedValue(addr);
                        const rawVal = sheet.getCell(addr);

                        if (rawVal.isFormula) {
                            td.classList.add('formula');
                            const jsVal = cellVal.toJs();
                            input.value = jsVal === null ? '' : jsVal;
                        } else {
                            td.classList.remove('formula');
                            const jsVal = cellVal.toJs();
                            input.value = jsVal === null ? '' : jsVal;
                        }
                    } catch (e) {
                        input.value = '#ERR';
                    }
                }
            }
        }

        main().catch(console.error);
    </script>
</body>
</html>
